<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Приди, меч!</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Обновленные CSS переменные */
    :root {
      --bg-color: #181818;
      --text-color: #E0E0E0;
      --highlight-color: #A0CFFF;
      --button-bg: #2a2a2a;
      --button-border: #404040;
      --sticker-height: 51px;
      --vertical-gap: 10px; /* Расстояние между кнопками */
      --font-size: 16px;
    }

    .theme-sepia {
      --bg-color: #F8F5E8;
      --text-color: #5C4033;
      --highlight-color: #9A3B3B;
      --button-bg: #e0d8c8;
      --button-border: #b0a898;
    }

    /* Защита от копирования */
    body {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    /* Обновленные стили стикеров */
    .nav-sticker {
      position: fixed;
      right: 0;
      background: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--text-color);
      width: 75px;
      height: var(--sticker-height);
      border-radius: 8px 0 0 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      font-family: 'Arial', sans-serif;
    }

      #themeSticker { top: calc(10% + (var(--sticker-height) * 0)); }
      #fontControls { top: calc(10% + (var(--sticker-height) * 1 + var(--vertical-gap))); }
      #homeSticker { top: calc(10% + (var(--sticker-height) * 2 + var(--vertical-gap) * 2)); }
      #prevSticker { top: calc(10% + (var(--sticker-height) * 3 + var(--vertical-gap) * 3)); }
      #tocSticker { top: calc(10% + (var(--sticker-height) * 4 + var(--vertical-gap) * 4)); }
      #nextSticker { top: calc(10% + (var(--sticker-height) * 5 + var(--vertical-gap) * 5)); }
      #scrollSticker { bottom: 10%; }

    .font-controls-container {
      display: flex;
      gap: 10px;
      padding: 0 10px;
    }

    .font-btn {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .font-btn:hover {
      transform: scale(1.1);
    }

    .hidden-sticker {
      transform: translateX(100%);
    }

/* Адаптация для мобильных */
     @media (max-width: 768px) {
     :root {
     --sticker-height: 34px;
     --vertical-gap: 5px;
      }

      .nav-sticker {
      width: 42px;
      }

      .chapter-content {
        max-width: 95%;
        padding: 10px;
      }

      .font-controls-container {
        gap: 5px;
        padding: 0 5px;
      }

      #themeSticker { top: calc(5% + (var(--sticker-height) * 0)); }
      #fontControls { top: calc(5% + (var(--sticker-height) * 1 + var(--vertical-gap))); }
      #homeSticker { top: calc(5% + (var(--sticker-height) * 2 + var(--vertical-gap) * 2)); }
      #prevSticker { top: calc(5% + (var(--sticker-height) * 3 + var(--vertical-gap) * 3)); }
      #tocSticker { top: calc(5% + (var(--sticker-height) * 4 + var(--vertical-gap) * 4)); }
      #nextSticker { top: calc(5% + (var(--sticker-height) * 5 + var(--vertical-gap) * 5)); }
      #scrollSticker { bottom: 5%; }
    }

    /* Остальные стили без изменений */
    .book-info span {
      font-weight: bold;
      text-decoration: underline;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
      font-size: var(--font-size);
      transition: background 0.3s, color 0.3s;
    }

    .container {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      gap: 20px;
      margin-top: 20px;
    }

    .book-cover {
      flex: 0 0 auto;
      width: 100%;
      max-width: 315px;
      height: auto;
      object-fit: cover;
      border-radius: 10px;
      align-self: stretch;
    }

    .book-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .book-title {
      font-size: 25px;
      margin-bottom: 10px;
      text-align: center;
      text-decoration: underline;
    }

    .book-description {
      font-size: 16px;
      margin-bottom: 30px;
      text-align: justify;
    }

    .author, .release-year, .genres, .tags, .alternative-title, .chapter-count {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .toc-item a {
      text-decoration: underline;
      color: var(--text-color);
      transition: color 0.3s;
    }

    .toc-item.active a {
      color: var(--highlight-color);
      font-weight: bold;
    }

    .toc-item a:hover {
      color: var(--highlight-color);
    }

    .table-of-contents {
      list-style: none;
      padding: 0;
      margin-top: 20px;
      text-align: left;
    }

    h3 {
      margin-top: 20px;
      text-align: center;
    }

    .loader {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #ff6347;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .chapter-content p {
      text-indent: 1.5em;
      margin-bottom: 1em;
    }

    .chapter-content h1,
    .chapter-content h2,
    .chapter-content h3 {
      text-align: center;
      margin: 2rem 0;
    }

    .chapter-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .chapter-content img {
      max-width: 100%;
      height: auto;
      margin: 15px 0;
      border-radius: 5px;
    }
  </style>
</head>
<body class="theme-graphite" oncopy="return false" oncut="return false" onpaste="return false">
  <header>
    <div class="container">
      <img src="images/book-cover_1.jpg" alt="Обложка книги Приди, меч!" class="book-cover">
      <div class="book-info">
        <h2 class="book-title">Приди, меч!</h2>
        <p><span>Автор:</span> 烽火戏剧王子</p>
        <p><span>Год выпуска:</span> 2017</p>
        <p><span>Количество глав:</span> 1162 (выпуск продолжается)</p>
        <p><span>Альтернативное название:</span> 剑来 / Jian Lai / Меч грядущего</p>
        <p><span>Жанры:</span> боевые искусства, драма, приключения, сёнэн, сянься (XianXia), фэнтези</p>
        <p><span>Тэги:</span> алхимия, буддизм, главный герой мужчина, древний мир, культивация, сирота, спокойный главный герой</p>
        <p class="book-description">
          <span>Аннотация:</span> Каких только чудес не бывает на свете.
          В центре мироздания обитает ученый, который однажды мечом рассек водопад Небесной реки, и никто из людей не гордится собой так, как он.
          На краю утесов Восточного моря обосновался безымянный даос, не пожелавший вознестись и прозябать на вершине горы. Он лишь хочет, чтобы прохладный ветерок овевал его лицо.
          В Западном раю живет старый монах, что любит рассказывать людям истории. Он держит девять небесных драконов.
          В Диких землях на южных окраинах живет слепой художник, заставивший марионеток в золотых доспехах сдвинуть множество огромных гор для создания прекрасной картины.
          Однажды бедный юноша, выросший на севере, увидел над головой тысячи бессмертных, летящих на мечах, подобно стае саранчи. Тогда ему захотелось пойти и своими глазами увидеть того ученого мужа, о котором рассказывал сказитель, а также бушующие приливы Восточного моря, бескрайние пески Запада и величественные горы Южной пустоши.
          И вот настал день, когда юноша взял деревянный меч и отправился на юг.
        </p>
      </div>
    </div>
  </header>

  <section>
    <h3>Содержание:</h3>
    <div class="loader" id="loader"></div>
    <ul class="table-of-contents" id="toc-list"></ul>
  </section>

  <div id="chapter-container" style="display: none;">
    <div class="chapter-content" id="chapter-content"></div>
  </div>

  <!-- Обновленные навигационные стикеры -->
  <div class="nav-sticker" id="themeSticker">☯</div>
  <div class="nav-sticker" id="fontControls">
    <div class="font-controls-container">
      <span class="font-btn" onclick="adjustFontSize(1)">A+</span>
      <span class="font-btn" onclick="adjustFontSize(-1)">A-</span>
    </div>
  </div>
  <div class="nav-sticker" id="homeSticker">⌂</div>
  <div class="nav-sticker" id="prevSticker">←</div>
  <div class="nav-sticker" id="tocSticker">≡</div>
  <div class="nav-sticker" id="nextSticker">→</div>
  <div class="nav-sticker" id="scrollSticker">↓</div>

  <script>
    // Управление видимостью стикеров
    let stickersVisible = true;
    document.body.addEventListener('click', (e) => {
      if (!e.target.closest('.nav-sticker')) {
        stickersVisible = !stickersVisible;
        document.querySelectorAll('.nav-sticker').forEach(sticker => {
          sticker.classList.toggle('hidden-sticker', !stickersVisible);
        });
      }
    });

    // Управление размером шрифта
    function adjustFontSize(change) {
      const minSize = 12;
      const maxSize = 20;
      let currentSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size'));
      currentSize = Math.min(maxSize, Math.max(minSize, currentSize + change));
      document.documentElement.style.setProperty('--font-size', `${currentSize}px`);
      localStorage.setItem('fontSize', currentSize);
    }

    // Инициализация размера шрифта
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
      document.documentElement.style.setProperty('--font-size', `${savedFontSize}px`);
    }

    // Остальной функционал без изменений
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'graphite';
      document.body.classList.add(`theme-${savedTheme}`);
    });

    const REPO_OWNER = 'Komataguri';
    const REPO_NAME = 'Microcosmos_Komataguri';
    const BOOK_PATH = 'chapters/Book1';
    const BASE_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/`;

    let chapters = [];
    let currentChapterIndex = localStorage.getItem('lastChapter') || 0;
    const loader = document.getElementById('loader');
    const tocList = document.getElementById('toc-list');
    const chapterContainer = document.getElementById('chapter-container');
    const chapterContent = document.getElementById('chapter-content');

    function scrollToBottom() {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadTableOfContents();
      if (localStorage.getItem('lastChapter')) {
        loadChapter(Number(localStorage.getItem('lastChapter')));
      }
    });

    async function loadTableOfContents() {
      try {
        toggleLoader(true);
        const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${BOOK_PATH}?t=${Date.now()}`);
        const files = await response.json();
        chapters = files
          .filter(file => file.name.endsWith('.md'))
          .sort((a, b) => parseInt(a.name.match(/\d+/)[0]) - parseInt(b.name.match(/\d+/)[0]));
        
        tocList.innerHTML = chapters.map((chapter, index) => `
          <li class="toc-item">
            <a onclick="loadChapter(${index})">${chapter.name.replace('.md', '')}</a>
          </li>
        `).join('');
      } catch (error) {
        tocList.innerHTML = `<li style="color: #ff4444">${error.message}</li>`;
      } finally {
        toggleLoader(false);
      }
    }

    async function loadChapter(index) {
      try {
        toggleLoader(true);
        currentChapterIndex = index;
        document.title = chapters[index].name.replace('.md', '') + ' | Приди, меч!';
        
        const response = await fetch(BASE_URL + chapters[index].path);
        let markdown = await response.text();
        
        markdown = markdown.replace(/!\[(.*?)\]\((.*?)\)/g, (_, alt, path) => 
          `![${alt}](${BASE_URL}${BOOK_PATH}/images/${path.split('/').pop()})`
        );
        
        chapterContent.innerHTML = marked.parse(markdown);
        chapterContainer.style.display = 'block';
        document.querySelector('header').style.display = 'none';
        document.querySelector('section').style.display = 'none';
        window.scrollTo(0, 0);

        document.querySelectorAll('.toc-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelectorAll('.toc-item')[index].classList.add('active');
        localStorage.setItem('lastChapter', currentChapterIndex);
      } catch (error) {
        chapterContent.innerHTML = `<div style="color: #ff4444">${error.message}</div>`;
      } finally {
        toggleLoader(false);
      }
    }

    function navigateChapter(direction) {
      const newIndex = currentChapterIndex + direction;
      if (newIndex >= 0 && newIndex < chapters.length) {
        loadChapter(newIndex);
      } else {
        alert(direction === 1 ? 'Это последняя глава' : 'Это первая глава');
      }
    }

    function toggleLoader(show) {
      loader.style.display = show ? 'block' : 'none';
    }

    document.getElementById('themeSticker').addEventListener('click', function() {
      const currentTheme = localStorage.getItem('theme') || 'graphite';
      const nextTheme = currentTheme === 'graphite' ? 'sepia' : 'graphite';
      document.body.classList.replace(`theme-${currentTheme}`, `theme-${nextTheme}`);
      localStorage.setItem('theme', nextTheme);
    });

    document.getElementById('homeSticker').addEventListener('click', () => window.location.href='index.html');
    document.getElementById('prevSticker').addEventListener('click', () => navigateChapter(-1));
    document.getElementById('nextSticker').addEventListener('click', () => navigateChapter(1));
    document.getElementById('tocSticker').addEventListener('click', () => window.location.href='chapter.html');
    document.getElementById('scrollSticker').addEventListener('click', () => {
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
      window.scrollY >= scrollHeight - 50 ? scrollToTop() : scrollToBottom();
    });
  </script>
</body>
</html>