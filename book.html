<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–∏–¥–∏, –º–µ—á!</title>

  <!-- marked.js –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- highlight.js (JS + –Ω–æ—á–Ω–∞—è —Ç–µ–º–∞) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg-color: #181818;
      --text-color: #E0E0E0;
      --highlight-color: #A0CFFF;
      --button-bg: #2a2a2a;
      --button-border: #404040;
      --sticker-height: 51px;
      --vertical-gap: 10px;
      --font-size: 16px;
    }

    .theme-graphite {
      --bg-color: #181818;
      --text-color: #E0E0E0;
      --highlight-color: #A0CFFF;
      --button-bg: #2a2a2a;
      --button-border: #404040;
    }

    .theme-sepia {
      --bg-color: #F8F5E8;
      --text-color: #5C4033;
      --highlight-color: #9A3B3B;
      --button-bg: #e0d8c8;
      --button-border: #b0a898;
    }

    img { display: block; margin: 0; padding: 0; }

body {
  font-family: 'Arial', sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  padding: 20px;
  font-size: var(--font-size);
  transition: background 0.3s, color 0.3s;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.nav-sticker {
  position: fixed; 
  right: 0; 
  background: var(--button-bg);
  border: 1px solid var(--button-border); 
  color: var(--text-color);
  width: 75px; 
  height: var(--sticker-height);
  border-radius: 8px 0 0 8px; 
  cursor: pointer;
  transition: transform 0.3s ease;
  display: flex; 
  align-items: center; 
  justify-content: center;
  z-index: 999; 
  font-family: 'Arial', sans-serif;
}

#themeSticker { top: calc(10% + (var(--sticker-height) * 0)); }
#fontControls { top: calc(10% + (var(--sticker-height) * 1 + var(--vertical-gap))); width: 125px; }
#homeSticker { top: calc(10% + (var(--sticker-height) * 2 + var(--vertical-gap) * 2)); }
#prevSticker { top: calc(10% + (var(--sticker-height) * 3 + var(--vertical-gap) * 3)); }
#tocSticker { top: calc(10% + (var(--sticker-height) * 4 + var(--vertical-gap) * 4)); }
#nextSticker { top: calc(10% + (var(--sticker-height) * 5 + var(--vertical-gap) * 5)); }
#scrollSticker { bottom: 10%; }

.font-controls-container { display: flex; gap: 10px; padding: 0 10px; }
.font-btn { cursor: pointer; transition: transform 0.2s; }
.font-btn:hover { transform: scale(1.1); }
.hidden-sticker { transform: translateX(100%); }
.label { font-weight: bold; text-decoration: underline; }

p, li, h1, h2, h3 { margin: 0; line-height: 1.6; }

.chapter-content p { text-indent: 2em; }
.chapter-content span[style*="font-style:italic"] { color: #7AA6FF !important; }
.chapter-content h1,
.chapter-content h2,
.chapter-content h3 { text-align: center; margin: 0; }

.container { display: flex; flex-direction: row; align-items: stretch; gap: 20px; margin-top: 20px; }
.book-cover { flex: 0 0 auto; width: 315px; height: auto; object-fit: contain; border-radius: 10px; align-self: stretch; }
.book-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; overflow: visible; max-height: none; }
.book-title { font-size: 25px; margin-bottom: 10px; text-align: center; text-decoration: underline; }
.book-info p, .book-description { font-size: var(--font-size); margin: 0; text-align: justify; }

.table-of-contents { list-style: none; padding: 0; margin-top: 20px; text-align: left; }
.toc-item a { text-decoration: underline; color: var(--text-color); transition: color 0.3s; cursor: pointer; }
.toc-item.active a { color: var(--highlight-color); font-weight: bold; }
.toc-item a:hover { color: var(--highlight-color); }
h3 { margin: 0; text-align: center; }

.loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #ff6347; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.chapter-content { max-width: 800px; margin: 0 auto; padding: 20px; opacity: 0; transform: translateY(6px); transition: opacity 320ms ease, transform 320ms ease; }
.chapter-content.visible { opacity: 1; transform: translateY(0); }
.chapter-content img { max-width: 100%; height: auto; margin: 15px 0; border-radius: 5px; }

@media (max-width: 768px) {
  .container { flex-direction: column; align-items: center; gap: 10px; }
  .book-cover { width: 100%; max-width: 315px; }
  .book-info { text-align: center; }
  .chapter-content { padding: 10px 3px; }
  .nav-sticker { width: 60px; height: 45px; font-size: 1rem; }
  #fontControls { width: 100px; }
}

pre code { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <img src="images/book-cover_1.jpg" alt="–û–±–ª–æ–∂–∫–∞ –∫–Ω–∏–≥–∏ –ü—Ä–∏–¥–∏, –º–µ—á!" class="book-cover">
      <div class="book-info">
        <h2 class="book-title"></h2>
        <p><span class="label">–ê–≤—Ç–æ—Ä:</span> <span class="book-author"></span></p>
        <p><span class="label">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</span> <span class="book-year"></span></p>
        <p><span class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–ª–∞–≤:</span> <span class="book-chapters"></span></p>
        <p><span class="label">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</span> <span class="book-alt"></span></p>
        <p><span class="label">–ñ–∞–Ω—Ä—ã:</span> <span class="book-genres"></span></p>
        <p><span class="label">–¢—ç–≥–∏:</span> <span class="book-tags"></span></p>
        <p class="book-description"><span class="label">–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:</span> <span class="book-desc"></span></p>
      </div>
    </div>
  </header>

  <section>
    <h3>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:</h3>
    <div class="loader" id="loader"></div>
    <ul class="table-of-contents" id="toc-list"></ul>
  </section>

  <div id="chapter-container" style="display: none;">
    <div class="chapter-content" id="chapter-content"></div>
  </div>

  <div class="nav-sticker" id="themeSticker">‚òØ</div>
  <div class="nav-sticker" id="fontControls">
    <div class="font-controls-container">
      <span class="font-btn" id="fontInc" title="–£–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç">A+</span>
      <span class="font-btn" id="fontDec" title="–£–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç">A-</span>
      <span class="font-btn" id="fontReset" title="–°–±—Ä–æ—Å–∏—Ç—å">‚Ü∫</span>
    </div>
  </div>
  <div class="nav-sticker" id="homeSticker">‚åÇ</div>
  <div class="nav-sticker" id="prevSticker">‚Üê</div>
  <div class="nav-sticker" id="tocSticker">‚â°</div>
  <div class="nav-sticker" id="nextSticker">‚Üí</div>
  <div class="nav-sticker" id="scrollSticker">‚Üì</div>
<div id="progressContainer" style="position: fixed; top:0; left:0; width:100%; height:4px; background: rgba(255,255,255,0.1); z-index:998;">
  <div id="progressBar" style="width:0%; height:100%; background: var(--highlight-color); transition: width 0.1s ease;"></div>
</div>

<script>
(function() {
  // === –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ DOM –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ===
  const REPO_OWNER = 'Komataguri';
  const REPO_NAME = 'Microcosmos_Komataguri';
  const BASE_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/`;
  const loader = document.getElementById('loader');
  const tocList = document.getElementById('toc-list');
  const chapterContainer = document.getElementById('chapter-container');
  const chapterContent = document.getElementById('chapter-content');
  const stickers = document.querySelectorAll('.nav-sticker');
  const scrollSticker = document.getElementById('scrollSticker');
  const progressBar = document.getElementById('progressBar');

  // === –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ —Å –≤–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫–æ–º ===
  scrollSticker.addEventListener('click', () => {
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    if (window.scrollY >= scrollHeight - 50) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      window.scrollTo({ top: scrollHeight, behavior: 'smooth' });
    }
    if (navigator.vibrate) navigator.vibrate(30);
  });

  // === –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ===
  ['copy', 'cut', 'paste'].forEach(evt => document.body.addEventListener(evt, e => e.preventDefault()));

  let stickersVisible = true;
  let chapters = [];
  let currentChapterIndex = Number(localStorage.getItem('lastChapter') || 0);

  // === Debounce ===
  function debounce(func, delay = 200) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

// --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–Ω–∏–≥
const BOOKS = {
  Book1: {
    title: '–ü–†–ò–î–ò, –ú–ï–ß!',
    author: 'ÁÉΩÁÅ´ÊàèÂâßÁéãÂ≠ê',
    year: '2017',
    chaptersCount: '1162 (–≤—ã–ø—É—Å–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è)',
    alt: 'ÂâëÊù• / Jian Lai / –ú–µ—á –≥—Ä—è–¥—É—â–µ–≥–æ',
    genres: '–±–æ–µ–≤—ã–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞, –¥—Ä–∞–º–∞, –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è, —Å—ë–Ω—ç–Ω, —Å—è–Ω—å—Å—è (XianXia), —Ñ—ç–Ω—Ç–µ–∑–∏',
    tags: '–∞–ª—Ö–∏–º–∏—è, –±—É–¥–¥–∏–∑–º, –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π –º—É–∂—á–∏–Ω–∞, –¥—Ä–µ–≤–Ω–∏–π –º–∏—Ä, –∫—É–ª—å—Ç–∏–≤–∞—Ü–∏—è, —Å–∏—Ä–æ—Ç–∞, —Å–ø–æ–∫–æ–π–Ω—ã–π –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π',
    description: `–ö–∞–∫–∏—Ö —Ç–æ–ª—å–∫–æ —á—É–¥–µ—Å –Ω–µ –±—ã–≤–∞–µ—Ç –Ω–∞ —Å–≤–µ—Ç–µ.
–í —Ü–µ–Ω—Ç—Ä–µ –º–∏—Ä–æ–∑–¥–∞–Ω–∏—è –æ–±–∏—Ç–∞–µ—Ç —É—á–µ–Ω—ã–π, –∫–æ—Ç–æ—Ä—ã–π –æ–¥–Ω–∞–∂–¥—ã –º–µ—á–æ–º —Ä–∞—Å—Å–µ–∫ –≤–æ–¥–æ–ø–∞–¥ –ù–µ–±–µ—Å–Ω–æ–π —Ä–µ–∫–∏, –∏ –Ω–∏–∫—Ç–æ –∏–∑ –ª—é–¥–µ–π –Ω–µ –≥–æ—Ä–¥–∏—Ç—Å—è —Å–æ–±–æ–π —Ç–∞–∫, –∫–∞–∫ –æ–Ω.
–ù–∞ –∫—Ä–∞—é —É—Ç–µ—Å–æ–≤ –í–æ—Å—Ç–æ—á–Ω–æ–≥–æ –º–æ—Ä—è –æ–±–æ—Å–Ω–æ–≤–∞–ª—Å—è –±–µ–∑—ã–º—è–Ω–Ω—ã–π –¥–∞–æ—Å, –Ω–µ –ø–æ–∂–µ–ª–∞–≤—à–∏–π –≤–æ–∑–Ω–µ—Å—Ç–∏—Å—å –∏ –ø—Ä–æ–∑—è–±–∞—Ç—å –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ –≥–æ—Ä—ã. –û–Ω –ª–∏—à—å —Ö–æ—á–µ—Ç, —á—Ç–æ–±—ã –ø—Ä–æ—Ö–ª–∞–¥–Ω—ã–π –≤–µ—Ç–µ—Ä–æ–∫ –æ–≤–µ–≤–∞–ª –µ–≥–æ –ª–∏—Ü–æ.
–í –ó–∞–ø–∞–¥–Ω–æ–º —Ä–∞—é –∂–∏–≤–µ—Ç —Å—Ç–∞—Ä—ã–π –º–æ–Ω–∞—Ö, —á—Ç–æ –ª—é–±–∏—Ç —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –ª—é–¥—è–º –∏—Å—Ç–æ—Ä–∏–∏. –û–Ω –¥–µ—Ä–∂–∏—Ç –¥–µ–≤—è—Ç—å –Ω–µ–±–µ—Å–Ω—ã—Ö –¥—Ä–∞–∫–æ–Ω–æ–≤.
–í –î–∏–∫–∏—Ö –∑–µ–º–ª—è—Ö –Ω–∞ —é–∂–Ω—ã—Ö –æ–∫—Ä–∞–∏–Ω–∞—Ö –∂–∏–≤–µ—Ç —Å–ª–µ–ø–æ–π —Ö—É–¥–æ–∂–Ω–∏–∫, –∑–∞—Å—Ç–∞–≤–∏–≤—à–∏–π –º–∞—Ä–∏–æ–Ω–µ—Ç–æ–∫ –≤ –∑–æ–ª–æ—Ç—ã—Ö –¥–æ—Å–ø–µ—Ö–∞—Ö —Å–¥–≤–∏–Ω—É—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–≥—Ä–æ–º–Ω—ã—Ö –≥–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã.
–û–¥–Ω–∞–∂–¥—ã –±–µ–¥–Ω—ã–π —é–Ω–æ—à–∞, –≤—ã—Ä–æ—Å—à–∏–π –Ω–∞ —Å–µ–≤–µ—Ä–µ, —É–≤–∏–¥–µ–ª –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π —Ç—ã—Å—è—á–∏ –±–µ—Å—Å–º–µ—Ä—Ç–Ω—ã—Ö, –ª–µ—Ç—è—â–∏—Ö –Ω–∞ –º–µ—á–∞—Ö, –ø–æ–¥–æ–±–Ω–æ —Å—Ç–∞–µ —Å–∞—Ä–∞–Ω—á–∏. –¢–æ–≥–¥–∞ –µ–º—É –∑–∞—Ö–æ—Ç–µ–ª–æ—Å—å –ø–æ–π—Ç–∏ –∏ —Å–≤–æ–∏–º–∏ –≥–ª–∞–∑–∞–º–∏ —É–≤–∏–¥–µ—Ç—å —Ç–æ–≥–æ —É—á–µ–Ω–æ–≥–æ –º—É–∂–∞, –æ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª —Å–∫–∞–∑–∏—Ç–µ–ª—å, –∞ —Ç–∞–∫–∂–µ –±—É—à—É—é—â–∏–µ –ø—Ä–∏–ª–∏–≤—ã –í–æ—Å—Ç–æ—á–Ω–æ–≥–æ –º–æ—Ä—è, –±–µ—Å–∫—Ä–∞–π–Ω–∏–µ –ø–µ—Å–∫–∏ –ó–∞–ø–∞–¥–∞ –∏ –≤–µ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥–æ—Ä—ã –Æ–∂–Ω–æ–π –ø—É—Å—Ç–æ—à–∏.
–ò –≤–æ—Ç –Ω–∞—Å—Ç–∞–ª –¥–µ–Ω—å, –∫–æ–≥–¥–∞ —é–Ω–æ—à–∞ –≤–∑—è–ª –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è –Ω–∞ —é–≥.`,
    cover: 'images/book-cover_1.jpg',
    path: 'chapters/Book1'
  },
  Book2: {
    title: '–ó–∞—Ç–º–∏—Ç—å –Ω–µ–±–µ—Å–∞',
    author: 'Chen Dong',
    year: '2010',
    chaptersCount: '1821',
    alt: '–û–∫—É—Ç—ã–≤–∞—è –Ω–µ–±–µ—Å–∞ / ÈÅÆÂ§© / Shrouding the Heavens / Zhe Tian / –ñ–µ—Ç—è–Ω—å',
    genres: '–±–æ–µ–≤—ã–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞, –¥—Ä–∞–º–∞, –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è, —Ä–æ–º–∞–Ω—Ç–∏–∫–∞, —Å—ë–Ω—ç–Ω, —Å—è–Ω—å—Å—è (XianXia), —Ñ—ç–Ω—Ç–µ–∑–∏',
    tags: '–∞–Ω–∏–º–µ, –±–µ–∑–∂–∞–ª–æ—Å—Ç–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏, –≥–∞—Ä–µ–º, –∫—É–ª—å—Ç–∏–≤–∞—Ü–∏—è, –æ—Ç —Å–ª–∞–±–æ–≥–æ –¥–æ —Å–∏–ª—å–Ω–æ–≥–æ, –¥—É–Ω—Ö—É–∞, –±—É–¥–¥–∏–∑–º, –¥–∞–æ—Å–∏–∑–º, –∫–æ–Ω—Ñ—É—Ü–∏–∞–Ω—Å—Ç–≤–æ',
    description: `–í —Ö–æ–ª–æ–¥–Ω—ã—Ö –∏ —Ç—ë–º–Ω—ã—Ö –≥–ª—É–±–∏–Ω–∞—Ö –í—Å–µ–ª–µ–Ω–Ω–æ–π –¥–µ–≤—è—Ç—å –æ–≥—Ä–æ–º–Ω—ã—Ö –¥—Ä–∞–∫–æ–Ω—å–∏—Ö —Ç—É—à —Ç—è–Ω—É—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å –Ω–µ–∑–∞–ø–∞–º—è—Ç–Ω—ã—Ö –≤—Ä–µ–º—ë–Ω –¥—Ä–µ–≤–Ω–∏–π –±—Ä–æ–Ω–∑–æ–≤—ã–π –≥—Ä–æ–±. 
–ù–æ —Ä–∞–¥–∏ —á–µ–≥–æ –º—ë—Ä—Ç–≤—ã–µ –¥—Ä–∞–∫–æ–Ω—ã –ø–µ—Ä–µ—Å–µ–∫–ª–∏ –∑–≤—ë–∑–¥–Ω—ã–µ –¥–∞–ª–∏? 
–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –º–∏—Ä –ª–µ–≥–µ–Ω–¥ –∏ –±–æ–µ–≤—ã—Ö –∏—Å–∫—É—Å—Å—Ç–≤, –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π —Å—Ç—Ä–∞–Ω–Ω—ã–º–∏ –∏ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏. 
–ö—Ä–æ–≤—å –∫–∏–ø–∏—Ç –∫–∞–∫ –ª–∞–≤–∞, —Å—Ç—Ä–∞—Å—Ç—å –±—É—à—É–µ—Ç –∫–∞–∫ –º–æ—Ä–µ, –∂–µ–ª–∞–Ω–∏—è –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω—ã –∫–∞–∫ –±–µ–∑–¥–Ω–∞... 
–° –ø–µ—Å–Ω–µ–π —Å–ª–µ–¥—É–π –ø–æ –¥–æ—Ä–æ–≥–µ –º–æ–≥—É—â–µ—Å—Ç–≤–∞, –∏ —Å–º–æ–∂–µ—à—å –∑–∞—Ç–º–∏—Ç—å –Ω–µ–±–µ—Å–∞ –æ–¥–Ω–∏–º —â–µ–ª—á–∫–æ–º –ø–∞–ª—å—Ü–µ–≤.`,
    cover: 'images/book-cover_2.jpg',
    path: 'chapters/Book2'
  }
};

  // === –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–Ω–∏–≥—É ===
  const params = new URLSearchParams(window.location.search);
  const bookKey = params.get('book') || 'Book1';
  const BOOK = BOOKS[bookKey];
  if (!BOOK) return alert('–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  const BOOK_PATH = BOOK.path;

  // === –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ===
  document.title = BOOK.title;
  const info = document.querySelector('.book-info');
  info.innerHTML = `
    <h2 class="book-title">${BOOK.title}</h2>
    <p><span class="label">–ê–≤—Ç–æ—Ä:</span> ${BOOK.author}</p>
    <p><span class="label">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</span> ${BOOK.year}</p>
    <p><span class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–ª–∞–≤:</span> ${BOOK.chaptersCount}</p>
    <p><span class="label">–ñ–∞–Ω—Ä—ã:</span> ${BOOK.genres}</p>
    <p class="book-description"><span class="label">–ê–Ω–Ω–æ—Ç–∞—Ü–∏—è:</span> ${BOOK.description}</p>
  `;
  document.querySelector('.book-cover').src = BOOK.cover;

  // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
  function extractChapterNumberString(f) {
    const m = f?.name.match(/–ì–ª–∞–≤–∞\s*([0-9]+)/);
    return m ? m[1] : null;
  }

  function updateURL(index) {
    const url = new URL(window.location);
    const num = extractChapterNumberString(chapters[index]);
    url.searchParams.set('chapter', num);
    window.history.replaceState({}, '', url);
  }

  function rewriteImagePaths(md) {
    return md.replace(/!\[(.*?)\]\((.*?)\)/g, (_, alt, path) =>
      `<img src="${BASE_URL}${BOOK_PATH}/${path.replace(/^\.\/?/, '')}" alt="${alt}" loading="lazy">`
    );
  }

  // === –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ ===
  function adjustFontSize(change) {
    const min = 12, max = 22;
    let curr = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size')) || 16;
    curr = Math.min(max, Math.max(min, curr + change));
    document.documentElement.style.setProperty('--font-size', `${curr}px`);
    localStorage.setItem('fontSize', curr);
  }
  function resetSettings() {
    document.documentElement.style.setProperty('--font-size', '16px');
    localStorage.setItem('fontSize', 16);
  }

  function toggleLoader(show) {
    loader.style.display = show ? 'block' : 'none';
  }

  // === –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä ===
  function updateProgressBar() {
    if (!chapterContainer || chapterContainer.style.display === 'none') {
      progressBar.style.width = '0%';
      return;
    }
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const percent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
    progressBar.style.width = percent + '%';
  }

  // === –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ ===
  function highlightCurrentTOC() {
    if (!chapterContainer || chapterContainer.style.display === 'none') return;
    const headings = chapterContent.querySelectorAll('h1,h2,h3');
    let current = 0;
    const midpoint = window.scrollY + window.innerHeight / 2;
    headings.forEach((h, i) => {
      if (midpoint >= h.offsetTop) current = i;
    });
    document.querySelectorAll('.toc-item').forEach(el => el.classList.remove('active'));
    const target = Array.from(tocList.children).find(li => li.textContent.trim() === headings[current]?.textContent.trim());
    if (target) target.classList.add('active');
  }

  window.addEventListener('scroll', debounce(() => {
    updateProgressBar();
    highlightCurrentTOC();
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    scrollSticker.innerHTML = (window.scrollY >= scrollHeight - 50) ? '‚Üë' : '‚Üì';
  }, 80));

  // === –°–∫—Ä—ã—Ç–∏–µ/–ø–æ–∫–∞–∑ —Å—Ç–∏–∫–µ—Ä–æ–≤ ===
  document.body.addEventListener('click', e => {
    if (e.target.closest('.nav-sticker')) return;
    stickersVisible = !stickersVisible;
    stickers.forEach(s => s.classList.toggle('hidden-sticker', !stickersVisible));
  });

  // === TOC ===
  async function loadTableOfContents() {
    try {
      toggleLoader(true);
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${BOOK_PATH}?t=${Date.now()}`);
      if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${res.status}`);
      chapters = (await res.json())
        .filter(f => f.name.endsWith('.md'))
        .sort((a, b) => (parseInt(a.name.match(/\d+/)) || 0) - (parseInt(b.name.match(/\d+/)) || 0));
      tocList.innerHTML = chapters.map((c, i) => `<li class="toc-item"><a data-index="${i}">${c.name.replace('.md','')}</a></li>`).join('');
      document.querySelectorAll('.toc-item a').forEach(a => a.addEventListener('click', () => {
        localStorage.setItem('tocScroll', window.scrollY);
        loadChapter(Number(a.dataset.index));
      }));
    } catch (e) {
      tocList.innerHTML = `<li style="color:#ff4444">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</li>`;
    } finally {
      toggleLoader(false);
    }
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤—ã (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫) ===
  async function loadChapter(index) {
    try {
      toggleLoader(true);
      currentChapterIndex = index;
      updateURL(index);
      localStorage.setItem('lastChapter', currentChapterIndex);

      const chapter = chapters[index];
      if (!chapter) throw new Error('–ì–ª–∞–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

      document.title = `${chapter.name.replace('.md','')} | ${BOOK.title}`;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
      let md = localStorage.getItem(chapter.name);
      if (!md) {
        const res = await fetch(BASE_URL + chapter.path);
        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã: ${res.status}`);
        md = await res.text();
        localStorage.setItem(chapter.name, md);
      }

      md = rewriteImagePaths(md);
      chapterContent.innerHTML = marked.parse(md);
      hljs.highlightAll();

      chapterContent.classList.remove('visible');
      setTimeout(() => chapterContent.classList.add('visible'), 10);
      chapterContainer.style.display = 'block';
      document.querySelector('header').style.display = 'none';
      document.querySelector('section').style.display = 'none';

      const key = `scroll_${chapter.name}`;
      const saved = Number(localStorage.getItem(key) || 0);
      setTimeout(() => window.scrollTo(0, saved), 50);
    } catch (e) {
      chapterContent.innerHTML = `
        <div style="color:#ff4444;text-align:center;">
          –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã.<br>${e.message}<br><br>
          <button onclick="location.reload()">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>`;
    } finally {
      toggleLoader(false);
    }
  }

  // === –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ TOC —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏ ===
  function navigateChapter(dir) {
    const newIndex = currentChapterIndex + dir;
    if (newIndex >= 0 && newIndex < chapters.length) loadChapter(newIndex);
    else alert(dir === 1 ? '–≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –≥–ª–∞–≤–∞' : '–≠—Ç–æ –ø–µ—Ä–≤–∞—è –≥–ª–∞–≤–∞');
  }

  function showTOC() {
    const savedTOCScroll = Number(localStorage.getItem('tocScroll') || 0);
    chapterContainer.style.display = 'none';
    document.querySelector('header').style.display = 'block';
    document.querySelector('section').style.display = 'block';
    setTimeout(() => window.scrollTo(0, savedTOCScroll), 100);
  }

  // === –°—Ç–∏–∫–µ—Ä—ã ===
  document.getElementById('themeSticker').onclick = () => {
    const curr = localStorage.getItem('theme') || 'graphite';
    const next = curr === 'graphite' ? 'sepia' : 'graphite';
    document.body.classList.replace(`theme-${curr}`, `theme-${next}`);
    localStorage.setItem('theme', next);
  };
  document.getElementById('fontInc').onclick = () => adjustFontSize(1);
  document.getElementById('fontDec').onclick = () => adjustFontSize(-1);
  document.getElementById('fontReset').onclick = () => resetSettings();
  document.getElementById('homeSticker').onclick = () => { window.location.href = 'index.html'; };
  document.getElementById('prevSticker').onclick = () => navigateChapter(-1);
  document.getElementById('nextSticker').onclick = () => navigateChapter(1);
  document.getElementById('tocSticker').onclick = showTOC;

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  window.addEventListener('DOMContentLoaded', async () => {
    document.body.classList.add(`theme-${localStorage.getItem('theme') || 'graphite'}`);
    const fs = localStorage.getItem('fontSize');
    if (fs) document.documentElement.style.setProperty('--font-size', `${fs}px`);

    await loadTableOfContents();
    const q = new URLSearchParams(window.location.search).get('chapter');
    if (q) {
      const i = chapters.findIndex(c => c.name.includes(q));
      if (i >= 0) loadChapter(i);
    }
  });
})();
</script>
</body>
</html>
