<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Приди, меч!</title>

  <!-- marked.js для рендера Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- highlight.js (JS + ночная тема) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg-color: #181818;
      --text-color: #E0E0E0;
      --highlight-color: #A0CFFF;
      --button-bg: #2a2a2a;
      --button-border: #404040;
      --sticker-height: 51px;
      --vertical-gap: 10px;
      --font-size: 16px;
    }

    .theme-graphite {
      --bg-color: #181818;
      --text-color: #E0E0E0;
      --highlight-color: #A0CFFF;
      --button-bg: #2a2a2a;
      --button-border: #404040;
    }

    .theme-sepia {
      --bg-color: #F8F5E8;
      --text-color: #5C4033;
      --highlight-color: #9A3B3B;
      --button-bg: #e0d8c8;
      --button-border: #b0a898;
    }

    img { display: block; margin: 0; padding: 0; }

body {
  font-family: 'Arial', sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  padding: 20px;
  font-size: var(--font-size);
  transition: background 0.3s, color 0.3s;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.nav-sticker {
  position: fixed; 
  right: 0; 
  background: var(--button-bg);
  border: 1px solid var(--button-border); 
  color: var(--text-color);
  width: 75px; 
  height: var(--sticker-height);
  border-radius: 8px 0 0 8px; 
  cursor: pointer;
  transition: transform 0.3s ease;
  display: flex; 
  align-items: center; 
  justify-content: center;
  z-index: 999; 
  font-family: 'Arial', sans-serif;
}

#themeSticker { top: calc(10% + (var(--sticker-height) * 0)); }
#fontControls { top: calc(10% + (var(--sticker-height) * 1 + var(--vertical-gap))); width: 125px; }
#homeSticker { top: calc(10% + (var(--sticker-height) * 2 + var(--vertical-gap) * 2)); }
#prevSticker { top: calc(10% + (var(--sticker-height) * 3 + var(--vertical-gap) * 3)); }
#tocSticker { top: calc(10% + (var(--sticker-height) * 4 + var(--vertical-gap) * 4)); }
#nextSticker { top: calc(10% + (var(--sticker-height) * 5 + var(--vertical-gap) * 5)); }
#scrollSticker { bottom: 10%; }

.font-controls-container { display: flex; gap: 10px; padding: 0 10px; }
.font-btn { cursor: pointer; transition: transform 0.2s; }
.font-btn:hover { transform: scale(1.1); }
.hidden-sticker { transform: translateX(100%); }
.label { font-weight: bold; text-decoration: underline; }

p, li, h1, h2, h3 { margin: 0; line-height: 1.6; }

.chapter-content p { text-indent: 2em; }
.chapter-content span[style*="font-style:italic"] { color: #7AA6FF !important; }
.chapter-content h1,
.chapter-content h2,
.chapter-content h3 { text-align: center; margin: 0; }

.container { display: flex; flex-direction: row; align-items: stretch; gap: 20px; margin-top: 20px; }
.book-cover { flex: 0 0 auto; width: 315px; height: auto; object-fit: contain; border-radius: 10px; align-self: stretch; }
.book-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; overflow: visible; max-height: none; }
.book-title { font-size: 25px; margin-bottom: 10px; text-align: center; text-decoration: underline; }
.book-info p, .book-description { font-size: var(--font-size); margin: 0; text-align: justify; }

.table-of-contents { list-style: none; padding: 0; margin-top: 20px; text-align: left; }
.toc-item a { text-decoration: underline; color: var(--text-color); transition: color 0.3s; cursor: pointer; }
.toc-item.active a { color: var(--highlight-color); font-weight: bold; }
.toc-item a:hover { color: var(--highlight-color); }
h3 { margin: 0; text-align: center; }

.loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #ff6347; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.chapter-content { max-width: 800px; margin: 0 auto; padding: 20px; opacity: 0; transform: translateY(6px); transition: opacity 320ms ease, transform 320ms ease; }
.chapter-content.visible { opacity: 1; transform: translateY(0); }
.chapter-content img { max-width: 100%; height: auto; margin: 15px 0; border-radius: 5px; }

@media (max-width: 768px) {
  .container { flex-direction: column; align-items: center; gap: 10px; }
  .book-cover { width: 100%; max-width: 315px; }
  .book-info { text-align: center; }
  .chapter-content { padding: 10px 3px; }
  .nav-sticker { width: 60px; height: 45px; font-size: 1rem; }
  #fontControls { width: 100px; }
}

pre code { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <img src="images/book-cover_1.jpg" alt="Обложка книги Приди, меч!" class="book-cover">
      <div class="book-info">
        <h2 class="book-title"></h2>
        <p><span class="label">Автор:</span> <span class="book-author"></span></p>
        <p><span class="label">Год выпуска:</span> <span class="book-year"></span></p>
        <p><span class="label">Количество глав:</span> <span class="book-chapters"></span></p>
        <p><span class="label">Альтернативное название:</span> <span class="book-alt"></span></p>
        <p><span class="label">Жанры:</span> <span class="book-genres"></span></p>
        <p><span class="label">Тэги:</span> <span class="book-tags"></span></p>
        <p class="book-description"><span class="label">Аннотация:</span> <span class="book-desc"></span></p>
      </div>
    </div>
  </header>

  <section>
    <h3>Содержание:</h3>
    <div class="loader" id="loader"></div>
    <ul class="table-of-contents" id="toc-list"></ul>
  </section>

  <div id="chapter-container" style="display: none;">
    <div class="chapter-content" id="chapter-content"></div>
  </div>

  <div class="nav-sticker" id="themeSticker">☯</div>
  <div class="nav-sticker" id="fontControls">
    <div class="font-controls-container">
      <span class="font-btn" id="fontInc" title="Увеличить шрифт">A+</span>
      <span class="font-btn" id="fontDec" title="Уменьшить шрифт">A-</span>
      <span class="font-btn" id="fontReset" title="Сбросить">↺</span>
    </div>
  </div>
  <div class="nav-sticker" id="homeSticker">⌂</div>
  <div class="nav-sticker" id="prevSticker">←</div>
  <div class="nav-sticker" id="tocSticker">≡</div>
  <div class="nav-sticker" id="nextSticker">→</div>
  <div class="nav-sticker" id="scrollSticker">↓</div>
<div id="progressContainer" style="position: fixed; top:0; left:0; width:100%; height:4px; background: rgba(255,255,255,0.1); z-index:998;">
  <div id="progressBar" style="width:0%; height:100%; background: var(--highlight-color); transition: width 0.1s ease;"></div>
</div>

<script>
(function() {
  // --- Переменные DOM
  const REPO_OWNER = 'Komataguri';
  const REPO_NAME = 'Microcosmos_Komataguri';
  const BASE_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/`;
  const loader = document.getElementById('loader');
  const tocList = document.getElementById('toc-list');
  const chapterContainer = document.getElementById('chapter-container');
  const chapterContent = document.getElementById('chapter-content');
  const stickers = document.querySelectorAll('.nav-sticker');
const scrollSticker = document.getElementById('scrollSticker');

scrollSticker.addEventListener('click', () => {
  const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
  if(window.scrollY >= scrollHeight - 50) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } else {
    window.scrollTo({ top: scrollHeight, behavior: 'smooth' });
  }
});

  // запрет копирования, вырезания и вставки
  document.body.addEventListener('copy', e => e.preventDefault());
  document.body.addEventListener('cut', e => e.preventDefault());
  document.body.addEventListener('paste', e => e.preventDefault());

  let stickersVisible = true;
  let chapters = [];
  let currentChapterIndex = Number(localStorage.getItem('lastChapter') || 0);

  // --- Универсальный debounce
  function debounce(func, delay = 200) {
    let timeoutId;
    return function(...args) {
      const context = this;
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => func.apply(context, args), delay);
    };
  }

// --- Конфигурация книг
const BOOKS = {
  Book1: {
    title: 'ПРИДИ, МЕЧ!',
    author: '烽火戏剧王子',
    year: '2017',
    chaptersCount: '1162 (выпуск продолжается)',
    alt: '剑来 / Jian Lai / Меч грядущего',
    genres: 'боевые искусства, драма, приключения, сёнэн, сянься (XianXia), фэнтези',
    tags: 'алхимия, буддизм, главный герой мужчина, древний мир, культивация, сирота, спокойный главный герой',
    description: `Каких только чудес не бывает на свете.
В центре мироздания обитает ученый, который однажды мечом рассек водопад Небесной реки, и никто из людей не гордится собой так, как он.
На краю утесов Восточного моря обосновался безымянный даос, не пожелавший вознестись и прозябать на вершине горы. Он лишь хочет, чтобы прохладный ветерок овевал его лицо.
В Западном раю живет старый монах, что любит рассказывать людям истории. Он держит девять небесных драконов.
В Диких землях на южных окраинах живет слепой художник, заставивший марионеток в золотых доспехах сдвинуть множество огромных гор для создания прекрасной картины.
Однажды бедный юноша, выросший на севере, увидел над головой тысячи бессмертных, летящих на мечах, подобно стае саранчи. Тогда ему захотелось пойти и своими глазами увидеть того ученого мужа, о котором рассказывал сказитель, а также бушующие приливы Восточного моря, бескрайние пески Запада и величественные горы Южной пустоши.
И вот настал день, когда юноша взял деревянный меч и отправился на юг.`,
    cover: 'images/book-cover_1.jpg',
    path: 'chapters/Book1'
  },
  Book2: {
    title: 'Затмить небеса',
    author: 'Chen Dong',
    year: '2010',
    chaptersCount: '1821',
    alt: 'Окутывая небеса / 遮天 / Shrouding the Heavens / Zhe Tian / Жетянь',
    genres: 'боевые искусства, драма, приключения, романтика, сёнэн, сянься (XianXia), фэнтези',
    tags: 'аниме, безжалостные персонажи, гарем, культивация, от слабого до сильного, дунхуа, буддизм, даосизм, конфуцианство',
    description: `В холодных и тёмных глубинах Вселенной девять огромных драконьих туш тянут существующий с незапамятных времён древний бронзовый гроб. 
Но ради чего мёртвые драконы пересекли звёздные дали? 
Бесконечно таинственный мир легенд и боевых искусств, наполненный странными и удивительными событиями. 
Кровь кипит как лава, страсть бушует как море, желания безграничны как бездна... 
С песней следуй по дороге могущества, и сможешь затмить небеса одним щелчком пальцев.`,
    cover: 'images/book-cover_2.jpg',
    path: 'chapters/Book2'
  }
};

  // --- Определение текущей книги
  const params = new URLSearchParams(window.location.search);
  let bookKey = params.get('book') || 'Book1';
  const BOOK = BOOKS[bookKey];
  if (!BOOK) {
    document.body.innerHTML = `<h2 style="color:#ff5555;text-align:center;margin-top:40px;">Книга "${bookKey}" не найдена</h2>`;
    throw new Error('Неизвестная книга');
  }

  // --- Применяем данные книги в интерфейс
  document.title = BOOK.title;
  const info = document.querySelector('.book-info');
  if (info && BOOK) {
    info.innerHTML = `
      <h2 class="book-title">${BOOK.title}</h2>
      <p><span class="label">Автор:</span> ${BOOK.author}</p>
      <p><span class="label">Год выпуска:</span> ${BOOK.year}</p>
      <p><span class="label">Количество глав:</span> ${BOOK.chaptersCount || '—'}</p>
      <p><span class="label">Альтернативное название:</span> ${BOOK.alt}</p>
      <p><span class="label">Жанры:</span> ${BOOK.genres}</p>
      <p><span class="label">Тэги:</span> ${BOOK.tags}</p>
      <p class="book-description"><span class="label">Аннотация:</span> ${BOOK.description}</p>
    `;
    document.querySelector('.book-cover').src = BOOK.cover;
  }

  const BOOK_PATH = BOOK.path;

  // --- Вспомогательные функции
  function extractChapterNumberString(file) {
    if (!file?.name) return null;
    const m = file.name.match(/Глава\s*([0-9]+)/);
    return m ? m[1] : null;
  }

  function extractChapterNumber(file) {
    const s = extractChapterNumberString(file);
    return s !== null ? Number(s) : null;
  }

  function getChapterFromURL() {
    const q = new URLSearchParams(window.location.search).get('chapter');
    if (!q) return null;
    for (let i = 0; i < chapters.length; i++) {
      const s = extractChapterNumberString(chapters[i]);
      if (s !== null && s === q) return i;
    }
    if (/^\d+$/.test(q)) {
      const num = Number(q);
      for (let i = 0; i < chapters.length; i++) {
        const n = extractChapterNumber(chapters[i]);
        if (n !== null && n === num) return i;
      }
    }
    try {
      const decoded = decodeURIComponent(q);
      for (let i = 0; i < chapters.length; i++) {
        const nameNoExt = chapters[i].name.replace(/\.md$/i, '');
        if (nameNoExt === decoded) return i;
        const nameWithoutPrefix = nameNoExt.replace(/^Глава\s*\d+\.\s*/i, '');
        if (nameWithoutPrefix === decoded) return i;
      }
    } catch (e) {}
    return null;
  }

  function updateURL(index) {
    if (!chapters) return;
    if (index < 0 || index >= chapters.length) return;
    const url = new URL(window.location);
    const numStr = extractChapterNumberString(chapters[index]);
    if (numStr !== null) url.searchParams.set('chapter', numStr);
    else url.searchParams.set('chapter', encodeURIComponent(chapters[index].name.replace(/\.md$/i, '')));
    window.history.replaceState({}, '', url);
  }

  function rewriteImagePaths(markdown) {
    return markdown.replace(/!\[(.*?)\]\((.*?)\)/g, (_, alt, path) =>
      `![${alt}](${BASE_URL}${BOOK_PATH}/${path.replace(/^\.\/?/, '')})`
    );
  }

  function adjustFontSize(change) {
    const min = 12, max = 22;
    let curr = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size')) || 16;
    curr = Math.min(max, Math.max(min, curr + change));
    document.documentElement.style.setProperty('--font-size', `${curr}px`);
    localStorage.setItem('fontSize', curr);
  }

  function resetSettings() {
    const def = 16;
    document.documentElement.style.setProperty('--font-size', `${def}px`);
    localStorage.setItem('fontSize', def);
  }

  function toggleLoader(show) { loader.style.display = show ? 'block' : 'none'; }

  const saveScrollDebounced = debounce(() => {
    if (!chapters || !chapters[currentChapterIndex]) return;
    localStorage.setItem(`scroll_${chapters[currentChapterIndex].name}`, window.scrollY);
  }, 300);

  const onScroll = debounce(() => {
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    scrollSticker.innerHTML = (window.scrollY >= scrollHeight - 50) ? '↑' : '↓';
    saveScrollDebounced();
  }, 80);

  const toggleStickersDebounced = debounce(() => {
    stickersVisible = !stickersVisible;
    stickers.forEach(s => s.classList.toggle('hidden-sticker', !stickersVisible));
  }, 180);

// --- Прогресс-бар прокрутки
const progressBar = document.getElementById('progressBar');
function updateProgressBar() {
  if(!chapterContainer || chapterContainer.style.display==='none') {
    progressBar.style.width='0%';
    return;
  }
  const scrollTop = window.scrollY;
  const docHeight = document.documentElement.scrollHeight - window.innerHeight;
  const percent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
  progressBar.style.width = percent + '%';
}

// --- Авто-подсветка текущего TOC по скроллу
function highlightCurrentTOC() {
  if(!chapterContainer || chapterContainer.style.display==='none') return;
  const headings = chapterContent.querySelectorAll('h1,h2,h3');
  let currentHeadingIndex = 0;
  headings.forEach((h,i)=>{
    if(window.scrollY + 60 >= h.offsetTop) currentHeadingIndex = i;
  });
  document.querySelectorAll('.toc-item').forEach(item => item.classList.remove('active'));
  if(headings[currentHeadingIndex]) {
    const tocItem = Array.from(tocList.children).find(li => li.textContent.trim() === headings[currentHeadingIndex].textContent.trim());
    if(tocItem) tocItem.classList.add('active');
  }
}

// --- Добавляем в существующий scroll listener
window.addEventListener('scroll', () => {
  updateProgressBar();
  highlightCurrentTOC();
});

  document.body.addEventListener('click', e => {
    if (e.target.closest('.nav-sticker')) return;
    toggleStickersDebounced();
  });

  window.addEventListener('scroll', onScroll);

  async function loadTableOfContents() {
    try {
      chapterContent.innerHTML = '';
      toggleLoader(true);
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${BOOK_PATH}?t=${Date.now()}`);
      if (!res.ok) throw new Error(`Ошибка HTTP: ${res.status}`);
      chapters = (await res.json())
        .filter(f => f.name.endsWith('.md'))
        .sort((a, b) => {
          const na = (a.name.match(/\d+/) || [0])[0];
          const nb = (b.name.match(/\d+/) || [0])[0];
          return parseInt(na) - parseInt(nb);
        });
      tocList.innerHTML = chapters.map((c, i) =>
        `<li class="toc-item"><a data-index="${i}">${c.name.replace('.md','')}</a></li>`
      ).join('');
      document.querySelectorAll('.toc-item a').forEach(a =>
        a.addEventListener('click', () => loadChapter(Number(a.dataset.index)))
      );
    } catch(e) {
      tocList.innerHTML = `<li style="color:#ff4444">${e.message}</li>`;
    } finally {
      toggleLoader(false);
    }
  }

  async function loadChapter(index) {
    try {
      chapterContent.innerHTML = '';
      toggleLoader(true);
      currentChapterIndex = index;
      updateURL(index);
      localStorage.setItem('lastChapter', currentChapterIndex);

      const chapter = chapters[index];
      if(!chapter) throw new Error('Глава не найдена');
      document.title = chapter.name.replace('.md','') + ' | ' + BOOK.title;

      const res = await fetch(BASE_URL + chapter.path);
      if(!res.ok) throw new Error('Глава не найдена');

      let md = await res.text();
      md = rewriteImagePaths(md);
      chapterContent.innerHTML = marked.parse(md);
      hljs.highlightAll();
      chapterContent.classList.remove('visible');
      setTimeout(()=>chapterContent.classList.add('visible'),10);

      chapterContainer.style.display='block';
      document.querySelector('header').style.display='none';
      document.querySelector('section').style.display='none';

      document.querySelectorAll('.toc-item').forEach(i=>i.classList.remove('active'));
      const tocItems=document.querySelectorAll('.toc-item');
      if(tocItems[index]) tocItems[index].classList.add('active');

      const key=`scroll_${chapters[currentChapterIndex].name}`;
      const saved=Number(localStorage.getItem(key)||0);
      setTimeout(()=>window.scrollTo(0,saved>0?saved:0),50);
    } catch(e) {
      chapterContent.innerHTML=`<div style="color:#ff4444">${e.message}</div>`;
    } finally {
      toggleLoader(false);
    }
  }

  function navigateChapter(dir){
    const newIndex = currentChapterIndex + dir;
    if(newIndex>=0 && newIndex<chapters.length) loadChapter(newIndex);
    else alert(dir===1?'Это последняя глава':'Это первая глава');
  }

  function showTOC(){
    chapterContainer.style.display='none';
    document.querySelector('header').style.display='block';
    document.querySelector('section').style.display='block';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  // === Обработчики стикеров ===
  const themeSticker = document.getElementById('themeSticker');
  if(themeSticker) themeSticker.addEventListener('click', () => {
      const current = localStorage.getItem('theme') || 'graphite';
      const next = current === 'graphite' ? 'sepia' : 'graphite';
      document.body.classList.replace(`theme-${current}`, `theme-${next}`);
      localStorage.setItem('theme', next);
  });

  const fontInc = document.getElementById('fontInc');
  if(fontInc) fontInc.addEventListener('click', () => adjustFontSize(1));
  const fontDec = document.getElementById('fontDec');
  if(fontDec) fontDec.addEventListener('click', () => adjustFontSize(-1));
  const fontReset = document.getElementById('fontReset');
  if(fontReset) fontReset.addEventListener('click', () => resetSettings());

  const homeSticker = document.getElementById('homeSticker');
  if(homeSticker) homeSticker.addEventListener('click', () => {
      const url = new URL(window.location);
      url.searchParams.delete('chapter');
      window.location.href='index.html';
  });

  const prevSticker = document.getElementById('prevSticker');
  if(prevSticker) prevSticker.addEventListener('click',()=>navigateChapter(-1));
  const nextSticker = document.getElementById('nextSticker');
  if(nextSticker) nextSticker.addEventListener('click',()=>navigateChapter(1));
  const tocSticker = document.getElementById('tocSticker');
  if(tocSticker) tocSticker.addEventListener('click',showTOC);

  // --- DOMContentLoaded
  window.addEventListener('DOMContentLoaded', async () => {
    const savedTheme = localStorage.getItem('theme') || 'graphite';
    document.body.classList.add(`theme-${savedTheme}`);

    const savedFontSize = localStorage.getItem('fontSize');
    if(savedFontSize) document.documentElement.style.setProperty('--font-size', `${savedFontSize}px`);

    await loadTableOfContents();
    const ch = getChapterFromURL();
    if (ch !== null && chapters[ch]) loadChapter(ch);
    else showTOC();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js', { scope: './' })
        .then(reg => console.log('Service worker зарегистрирован:', reg.scope))
        .catch(err => console.warn('Не удалось зарегистрировать service worker:', err));
    }
  });

})();
</script>
</body>
</html>
