<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Приди, меч!</title>

  <!-- marked.js для рендера Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- highlight.js (JS + ночная тема) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg-color: #181818;
      --text-color: #E0E0E0;
      --highlight-color: #A0CFFF;
      --button-bg: #2a2a2a;
      --button-border: #404040;
      --sticker-height: 51px;
      --vertical-gap: 10px;
      --font-size: 16px;
    }

    .theme-graphite {
      --bg-color: #181818;
      --text-color: #E0E0E0;
      --highlight-color: #A0CFFF;
      --button-bg: #2a2a2a;
      --button-border: #404040;
    }

    .theme-sepia {
      --bg-color: #F8F5E8;
      --text-color: #5C4033;
      --highlight-color: #9A3B3B;
      --button-bg: #e0d8c8;
      --button-border: #b0a898;
    }

    img { display: block; margin: 0; padding: 0; }

body {
  font-family: 'Arial', sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  padding: 20px;
  font-size: var(--font-size);
  transition: background 0.3s, color 0.3s;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.nav-sticker {
  position: fixed; 
  right: 0; 
  background: var(--button-bg);
  border: 1px solid var(--button-border); 
  color: var(--text-color);
  width: 75px; 
  height: var(--sticker-height);
  border-radius: 8px 0 0 8px; 
  cursor: pointer;
  transition: transform 0.3s ease;
  display: flex; 
  align-items: center; 
  justify-content: center;
  z-index: 999; 
  font-family: 'Arial', sans-serif;
}

#themeSticker { top: calc(10% + (var(--sticker-height) * 0)); }
#fontControls { top: calc(10% + (var(--sticker-height) * 1 + var(--vertical-gap))); width: 125px; }
#homeSticker { top: calc(10% + (var(--sticker-height) * 2 + var(--vertical-gap) * 2)); }
#prevSticker { top: calc(10% + (var(--sticker-height) * 3 + var(--vertical-gap) * 3)); }
#tocSticker { top: calc(10% + (var(--sticker-height) * 4 + var(--vertical-gap) * 4)); }
#nextSticker { top: calc(10% + (var(--sticker-height) * 5 + var(--vertical-gap) * 5)); }
#scrollSticker { bottom: 10%; }

.font-controls-container { display: flex; gap: 10px; padding: 0 10px; }
.font-btn { cursor: pointer; transition: transform 0.2s; }
.font-btn:hover { transform: scale(1.1); }
.hidden-sticker { transform: translateX(100%); }
.label { font-weight: bold; text-decoration: underline; }

p, li, h1, h2, h3 { margin: 0; line-height: 1.6; }

.chapter-content p { text-indent: 2em; }
.chapter-content span[style*="font-style:italic"] { color: #7AA6FF !important; }
.chapter-content h1,
.chapter-content h2,
.chapter-content h3 { text-align: center; margin: 0; }

.container { display: flex; flex-direction: row; align-items: stretch; gap: 20px; margin-top: 20px; }
.book-cover { flex: 0 0 auto; width: 315px; height: auto; object-fit: contain; border-radius: 10px; align-self: stretch; }
.book-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; overflow: visible; max-height: none; }
.book-title { font-size: 25px; margin-bottom: 10px; text-align: center; text-decoration: underline; }
.book-info p, .book-description { font-size: var(--font-size); margin: 0; text-align: justify; }

.table-of-contents { list-style: none; padding: 0; margin-top: 20px; text-align: left; }
.toc-item a { text-decoration: underline; color: var(--text-color); transition: color 0.3s; cursor: pointer; }
.toc-item.active a { color: var(--highlight-color); font-weight: bold; }
.toc-item a:hover { color: var(--highlight-color); }
h3 { margin: 0; text-align: center; }

.loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid #ff6347; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.chapter-content { max-width: 800px; margin: 0 auto; padding: 20px; opacity: 0; transform: translateY(6px); transition: opacity 320ms ease, transform 320ms ease; }
.chapter-content.visible { opacity: 1; transform: translateY(0); }
.chapter-content img { max-width: 100%; height: auto; margin: 15px 0; border-radius: 5px; }

@media (max-width: 768px) {
  .container { flex-direction: column; align-items: center; gap: 10px; }
  .book-cover { width: 100%; max-width: 315px; }
  .book-info { text-align: center; }
  .chapter-content { padding: 10px 3px; }
  .nav-sticker { width: 60px; height: 45px; font-size: 1rem; }
  #fontControls { width: 100px; }
}

pre code { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <img src="images/book-cover_1.jpg" alt="Обложка книги Приди, меч!" class="book-cover">
      <div class="book-info">
        <h2 class="book-title"></h2>
        <p><span class="label">Автор:</span> <span class="book-author"></span></p>
        <p><span class="label">Год выпуска:</span> <span class="book-year"></span></p>
        <p><span class="label">Количество глав:</span> <span class="book-chapters"></span></p>
        <p><span class="label">Альтернативное название:</span> <span class="book-alt"></span></p>
        <p><span class="label">Жанры:</span> <span class="book-genres"></span></p>
        <p><span class="label">Тэги:</span> <span class="book-tags"></span></p>
        <p class="book-description"><span class="label">Аннотация:</span> <span class="book-desc"></span></p>
      </div>
    </div>
  </header>

  <section>
    <h3>Содержание:</h3>
    <div class="loader" id="loader"></div>
    <ul class="table-of-contents" id="toc-list"></ul>
  </section>

  <div id="chapter-container" style="display: none;">
    <div class="chapter-content" id="chapter-content"></div>
  </div>

  <div class="nav-sticker" id="themeSticker">☯</div>
  <div class="nav-sticker" id="fontControls">
    <div class="font-controls-container">
      <span class="font-btn" id="fontInc" title="Увеличить шрифт">A+</span>
      <span class="font-btn" id="fontDec" title="Уменьшить шрифт">A-</span>
      <span class="font-btn" id="fontReset" title="Сбросить">↺</span>
    </div>
  </div>
  <div class="nav-sticker" id="homeSticker">⌂</div>
  <div class="nav-sticker" id="prevSticker">←</div>
  <div class="nav-sticker" id="tocSticker">≡</div>
  <div class="nav-sticker" id="nextSticker">→</div>
  <div class="nav-sticker" id="scrollSticker">↓</div>
<div id="progressContainer" style="position: fixed; top:0; left:0; width:100%; height:4px; background: rgba(255,255,255,0.1); z-index:998;">
  <div id="progressBar" style="width:0%; height:100%; background: var(--highlight-color); transition: width 0.1s ease;"></div>
</div>

<script>
(function() {
  // === Переменные DOM и константы ===
  const REPO_OWNER = 'Komataguri';
  const REPO_NAME = 'Microcosmos_Komataguri';
  const BASE_URL = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/`;
  const loader = document.getElementById('loader');
  const tocList = document.getElementById('toc-list');
  const chapterContainer = document.getElementById('chapter-container');
  const chapterContent = document.getElementById('chapter-content');
  const stickers = document.querySelectorAll('.nav-sticker');
  const scrollSticker = document.getElementById('scrollSticker');
  const progressBar = document.getElementById('progressBar');

  // === Прокрутка вверх/вниз с виброоткликом ===
  scrollSticker.addEventListener('click', () => {
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    if (window.scrollY >= scrollHeight - 50) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      window.scrollTo({ top: scrollHeight, behavior: 'smooth' });
    }
    if (navigator.vibrate) navigator.vibrate(30);
  });

  // === Защита от копирования ===
  ['copy', 'cut', 'paste'].forEach(evt => document.body.addEventListener(evt, e => e.preventDefault()));

  let stickersVisible = true;
  let chapters = [];
  let currentChapterIndex = Number(localStorage.getItem('lastChapter') || 0);

  // === Debounce ===
  function debounce(func, delay = 200) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

// --- Конфигурация книг
const BOOKS = {
  Book1: {
    title: 'ПРИДИ, МЕЧ!',
    author: '烽火戏剧王子',
    year: '2017',
    chaptersCount: '1162 (выпуск продолжается)',
    alt: '剑来 / Jian Lai / Меч грядущего',
    genres: 'боевые искусства, драма, приключения, сёнэн, сянься (XianXia), фэнтези',
    tags: 'алхимия, буддизм, главный герой мужчина, древний мир, культивация, сирота, спокойный главный герой',
    description: `Каких только чудес не бывает на свете.
В центре мироздания обитает ученый, который однажды мечом рассек водопад Небесной реки, и никто из людей не гордится собой так, как он.
На краю утесов Восточного моря обосновался безымянный даос, не пожелавший вознестись и прозябать на вершине горы. Он лишь хочет, чтобы прохладный ветерок овевал его лицо.
В Западном раю живет старый монах, что любит рассказывать людям истории. Он держит девять небесных драконов.
В Диких землях на южных окраинах живет слепой художник, заставивший марионеток в золотых доспехах сдвинуть множество огромных гор для создания прекрасной картины.
Однажды бедный юноша, выросший на севере, увидел над головой тысячи бессмертных, летящих на мечах, подобно стае саранчи. Тогда ему захотелось пойти и своими глазами увидеть того ученого мужа, о котором рассказывал сказитель, а также бушующие приливы Восточного моря, бескрайние пески Запада и величественные горы Южной пустоши.
И вот настал день, когда юноша взял деревянный меч и отправился на юг.`,
    cover: 'images/book-cover_1.jpg',
    path: 'chapters/Book1'
  },
  Book2: {
    title: 'Затмить небеса',
    author: 'Chen Dong',
    year: '2010',
    chaptersCount: '1821',
    alt: 'Окутывая небеса / 遮天 / Shrouding the Heavens / Zhe Tian / Жетянь',
    genres: 'боевые искусства, драма, приключения, романтика, сёнэн, сянься (XianXia), фэнтези',
    tags: 'аниме, безжалостные персонажи, гарем, культивация, от слабого до сильного, дунхуа, буддизм, даосизм, конфуцианство',
    description: `В холодных и тёмных глубинах Вселенной девять огромных драконьих туш тянут существующий с незапамятных времён древний бронзовый гроб. 
Но ради чего мёртвые драконы пересекли звёздные дали? 
Бесконечно таинственный мир легенд и боевых искусств, наполненный странными и удивительными событиями. 
Кровь кипит как лава, страсть бушует как море, желания безграничны как бездна... 
С песней следуй по дороге могущества, и сможешь затмить небеса одним щелчком пальцев.`,
    cover: 'images/book-cover_2.jpg',
    path: 'chapters/Book2'
  }
};

  // === Определяем текущую книгу ===
  const params = new URLSearchParams(window.location.search);
  const bookKey = params.get('book') || 'Book1';
  const BOOK = BOOKS[bookKey];
  if (!BOOK) return alert('Книга не найдена');
  const BOOK_PATH = BOOK.path;

  // === Применяем данные книги в интерфейс ===
  document.title = BOOK.title;
  const info = document.querySelector('.book-info');
  info.innerHTML = `
    <h2 class="book-title">${BOOK.title}</h2>
    <p><span class="label">Автор:</span> ${BOOK.author}</p>
    <p><span class="label">Год выпуска:</span> ${BOOK.year}</p>
    <p><span class="label">Количество глав:</span> ${BOOK.chaptersCount}</p>
    <p><span class="label">Жанры:</span> ${BOOK.genres}</p>
    <p class="book-description"><span class="label">Аннотация:</span> ${BOOK.description}</p>
  `;
  document.querySelector('.book-cover').src = BOOK.cover;

  // === Вспомогательные функции ===
  function extractChapterNumberString(f) {
    const m = f?.name.match(/Глава\s*([0-9]+)/);
    return m ? m[1] : null;
  }

  function updateURL(index) {
    const url = new URL(window.location);
    const num = extractChapterNumberString(chapters[index]);
    url.searchParams.set('chapter', num);
    window.history.replaceState({}, '', url);
  }

  function rewriteImagePaths(md) {
    return md.replace(/!\[(.*?)\]\((.*?)\)/g, (_, alt, path) =>
      `<img src="${BASE_URL}${BOOK_PATH}/${path.replace(/^\.\/?/, '')}" alt="${alt}" loading="lazy">`
    );
  }

  // === Кэширование шрифта ===
  function adjustFontSize(change) {
    const min = 12, max = 22;
    let curr = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--font-size')) || 16;
    curr = Math.min(max, Math.max(min, curr + change));
    document.documentElement.style.setProperty('--font-size', `${curr}px`);
    localStorage.setItem('fontSize', curr);
  }
  function resetSettings() {
    document.documentElement.style.setProperty('--font-size', '16px');
    localStorage.setItem('fontSize', 16);
  }

  function toggleLoader(show) {
    loader.style.display = show ? 'block' : 'none';
  }

  // === Прогресс-бар ===
  function updateProgressBar() {
    if (!chapterContainer || chapterContainer.style.display === 'none') {
      progressBar.style.width = '0%';
      return;
    }
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const percent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
    progressBar.style.width = percent + '%';
  }

  // === Подсветка активного заголовка ===
  function highlightCurrentTOC() {
    if (!chapterContainer || chapterContainer.style.display === 'none') return;
    const headings = chapterContent.querySelectorAll('h1,h2,h3');
    let current = 0;
    const midpoint = window.scrollY + window.innerHeight / 2;
    headings.forEach((h, i) => {
      if (midpoint >= h.offsetTop) current = i;
    });
    document.querySelectorAll('.toc-item').forEach(el => el.classList.remove('active'));
    const target = Array.from(tocList.children).find(li => li.textContent.trim() === headings[current]?.textContent.trim());
    if (target) target.classList.add('active');
  }

  window.addEventListener('scroll', debounce(() => {
    updateProgressBar();
    highlightCurrentTOC();
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    scrollSticker.innerHTML = (window.scrollY >= scrollHeight - 50) ? '↑' : '↓';
  }, 80));

  // === Скрытие/показ стикеров ===
  document.body.addEventListener('click', e => {
    if (e.target.closest('.nav-sticker')) return;
    stickersVisible = !stickersVisible;
    stickers.forEach(s => s.classList.toggle('hidden-sticker', !stickersVisible));
  });

  // === TOC ===
  async function loadTableOfContents() {
    try {
      toggleLoader(true);
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${BOOK_PATH}?t=${Date.now()}`);
      if (!res.ok) throw new Error(`Ошибка HTTP: ${res.status}`);
      chapters = (await res.json())
        .filter(f => f.name.endsWith('.md'))
        .sort((a, b) => (parseInt(a.name.match(/\d+/)) || 0) - (parseInt(b.name.match(/\d+/)) || 0));
      tocList.innerHTML = chapters.map((c, i) => `<li class="toc-item"><a data-index="${i}">${c.name.replace('.md','')}</a></li>`).join('');
      document.querySelectorAll('.toc-item a').forEach(a => a.addEventListener('click', () => {
        localStorage.setItem('tocScroll', window.scrollY);
        loadChapter(Number(a.dataset.index));
      }));
    } catch (e) {
      tocList.innerHTML = `<li style="color:#ff4444">Ошибка загрузки: ${e.message}</li>`;
    } finally {
      toggleLoader(false);
    }
  }

  // === Загрузка главы (с кэшированием и обработкой ошибок) ===
  async function loadChapter(index) {
    try {
      toggleLoader(true);
      currentChapterIndex = index;
      updateURL(index);
      localStorage.setItem('lastChapter', currentChapterIndex);

      const chapter = chapters[index];
      if (!chapter) throw new Error('Глава не найдена');

      document.title = `${chapter.name.replace('.md','')} | ${BOOK.title}`;

      // Проверяем кэш
      let md = localStorage.getItem(chapter.name);
      if (!md) {
        const res = await fetch(BASE_URL + chapter.path);
        if (!res.ok) throw new Error(`Ошибка загрузки главы: ${res.status}`);
        md = await res.text();
        localStorage.setItem(chapter.name, md);
      }

      md = rewriteImagePaths(md);
      chapterContent.innerHTML = marked.parse(md);
      hljs.highlightAll();

      chapterContent.classList.remove('visible');
      setTimeout(() => chapterContent.classList.add('visible'), 10);
      chapterContainer.style.display = 'block';
      document.querySelector('header').style.display = 'none';
      document.querySelector('section').style.display = 'none';

      const key = `scroll_${chapter.name}`;
      const saved = Number(localStorage.getItem(key) || 0);
      setTimeout(() => window.scrollTo(0, saved), 50);
    } catch (e) {
      chapterContent.innerHTML = `
        <div style="color:#ff4444;text-align:center;">
          Ошибка загрузки главы.<br>${e.message}<br><br>
          <button onclick="location.reload()">🔄 Попробовать снова</button>
        </div>`;
    } finally {
      toggleLoader(false);
    }
  }

  // === Навигация и возврат в TOC с сохранением позиции ===
  function navigateChapter(dir) {
    const newIndex = currentChapterIndex + dir;
    if (newIndex >= 0 && newIndex < chapters.length) loadChapter(newIndex);
    else alert(dir === 1 ? 'Это последняя глава' : 'Это первая глава');
  }

  function showTOC() {
    const savedTOCScroll = Number(localStorage.getItem('tocScroll') || 0);
    chapterContainer.style.display = 'none';
    document.querySelector('header').style.display = 'block';
    document.querySelector('section').style.display = 'block';
    setTimeout(() => window.scrollTo(0, savedTOCScroll), 100);
  }

  // === Стикеры ===
  document.getElementById('themeSticker').onclick = () => {
    const curr = localStorage.getItem('theme') || 'graphite';
    const next = curr === 'graphite' ? 'sepia' : 'graphite';
    document.body.classList.replace(`theme-${curr}`, `theme-${next}`);
    localStorage.setItem('theme', next);
  };
  document.getElementById('fontInc').onclick = () => adjustFontSize(1);
  document.getElementById('fontDec').onclick = () => adjustFontSize(-1);
  document.getElementById('fontReset').onclick = () => resetSettings();
  document.getElementById('homeSticker').onclick = () => { window.location.href = 'index.html'; };
  document.getElementById('prevSticker').onclick = () => navigateChapter(-1);
  document.getElementById('nextSticker').onclick = () => navigateChapter(1);
  document.getElementById('tocSticker').onclick = showTOC;

  // === Инициализация ===
  window.addEventListener('DOMContentLoaded', async () => {
    document.body.classList.add(`theme-${localStorage.getItem('theme') || 'graphite'}`);
    const fs = localStorage.getItem('fontSize');
    if (fs) document.documentElement.style.setProperty('--font-size', `${fs}px`);

    await loadTableOfContents();
    const q = new URLSearchParams(window.location.search).get('chapter');
    if (q) {
      const i = chapters.findIndex(c => c.name.includes(q));
      if (i >= 0) loadChapter(i);
    }
  });
})();
</script>
</body>
</html>
